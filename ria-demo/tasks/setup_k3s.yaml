- name: Install k3s
  ansible.builtin.shell: |
    curl -sfL https://get.k3s.io | sh -
  args:
    creates: /usr/local/bin/k3s

- name: Configure Traefik with fixed NodePorts
  ansible.builtin.copy:
    dest: /var/lib/rancher/k3s/server/manifests/traefik.yaml
    content: |
      ---
      apiVersion: helm.cattle.io/v1
      kind: HelmChart
      metadata:
        name: traefik-crd
        namespace: kube-system
      spec:
        chart: https://%{KUBERNETES_API}%/static/charts/traefik-crd-34.2.1+up34.2.0.tgz
      ---
      apiVersion: helm.cattle.io/v1
      kind: HelmChart
      metadata:
        name: traefik
        namespace: kube-system
      spec:
        chart: https://%{KUBERNETES_API}%/static/charts/traefik-34.2.1+up34.2.0.tgz
        set:
          global.systemDefaultRegistry: ""
        valuesContent: |-
          deployment:
            podAnnotations:
              prometheus.io/port: "8082"
              prometheus.io/scrape: "true"
          providers:
            kubernetesIngress:
              publishedService:
                enabled: true
          priorityClassName: "system-cluster-critical"
          image:
            repository: "rancher/mirrored-library-traefik"
            tag: "3.3.6"
          tolerations:
          - key: "CriticalAddonsOnly"
            operator: "Exists"
          - key: "node-role.kubernetes.io/control-plane"
            operator: "Exists"
            effect: "NoSchedule"
          - key: "node-role.kubernetes.io/master"
            operator: "Exists"
            effect: "NoSchedule"
          service:
            ipFamilyPolicy: "PreferDualStack"
            type: NodePort
            ports:
              web:
                nodePort: 30080
              websecure:
                nodePort: 30443

- name: Start k3s service
  ansible.builtin.systemd:
    name: k3s
    state: started
    enabled: true

- name: Ensure k3s config is readable
  ansible.builtin.file:
    path: /etc/rancher/k3s/k3s.yaml
    mode: "0755"

- name: Install kubectl binary link
  ansible.builtin.file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/kubectl
    state: link

- name: Wait for Kubernetes API to become available
  become: false
  retries: 20
  delay: 5
  register: result
  until: result.rc == 0
  ansible.builtin.shell: kubectl get nodes
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml